import ipywidgets as widgets
from IPython.display import display, HTML, Image, clear_output
import json
import os
import hashlib
import datetime
import requests
import random
import urllib.parse
import time
import uuid
import base64

# User management class with role and template support
class UserManager:
    USER_DB_FILE = "user_database.json"
    TEMPLATE_DB_FILE = "templates.json"
    MASTER_USERNAME = "master123"
    DEFAULT_MASTER_PASSWORD = "master@123"

    def __init__(self):
        self.users = {}
        self.templates = {}
        self.current_user = None
        self.current_role = None
        self.load_users()
        self.load_templates()
        self.create_master_user()

    def load_users(self):
        """Load user database from file"""
        if os.path.exists(self.USER_DB_FILE):
            try:
                with open(self.USER_DB_FILE, 'r') as f:
                    self.users = json.load(f)
            except:
                self.users = {}

    def save_users(self):
        """Save user database to file"""
        with open(self.USER_DB_FILE, 'w') as f:
            json.dump(self.users, f)

    def load_templates(self):
        """Load template database from file"""
        if os.path.exists(self.TEMPLATE_DB_FILE):
            try:
                with open(self.TEMPLATE_DB_FILE, 'r') as f:
                    self.templates = json.load(f)
            except:
                self.templates = {}

    def save_templates(self):
        """Save template database to file"""
        with open(self.TEMPLATE_DB_FILE, 'w') as f:
            json.dump(self.templates, f)

    def create_master_user(self):
        """Create master user if not exists"""
        if self.MASTER_USERNAME not in self.users:
            salt = os.urandom(16)
            hashed_pw = hashlib.pbkdf2_hmac(
                'sha256',
                self.DEFAULT_MASTER_PASSWORD.encode(),
                salt,
                100000
            )
            self.users[self.MASTER_USERNAME] = {
                "password": hashed_pw.hex(),
                "salt": salt.hex(),
                "industry_code": "ADMIN-001",
                "role": "master",
                "created_at": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "template_id": None
            }
            self.save_users()

    def create_user(self, username, password, industry_code, template_id=None):
        """Create a new user account with role and optional template assignment"""
        if username in self.users:
            return False, "Username already exists"

        role = "master" if username == self.MASTER_USERNAME else "client"

        # Validate template_id if provided
        if template_id and template_id not in self.templates:
            return False, "Invalid template ID"

        # Hash password
        salt = os.urandom(16)
        hashed_pw = hashlib.pbkdf2_hmac('sha256', password.encode(), salt, 100000)

        # Store user with template
        self.users[username] = {
            "password": hashed_pw.hex(),
            "salt": salt.hex(),
            "industry_code": industry_code,
            "role": role,
            "created_at": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "template_id": template_id
        }
        self.save_users()
        return True, f"Account created successfully. Role: {role}"

    def authenticate(self, username, password):
        """Authenticate a user and set role"""
        if username not in self.users:
            return False, "User not found"

        user = self.users[username]
        salt = bytes.fromhex(user['salt'])
        hashed_pw = hashlib.pbkdf2_hmac('sha256', password.encode(), salt, 100000)

        if hashed_pw.hex() != user['password']:
            return False, "Invalid password"

        self.current_user = username
        self.current_role = user['role']
        return True, f"Login successful. Role: {user['role']}"

    def logout(self):
        """Log out current user"""
        self.current_user = None
        self.current_role = None
        return "You have been logged out"

    def create_template(self, template_name, industry_code, subject, styles, creator):
        """Create a new template (master only) with subject and multiple styles"""
        if creator != self.MASTER_USERNAME or self.current_role != "master":
            return False, "Only master users can create templates"

        template_id = str(uuid.uuid4())
        self.templates[template_id] = {
            "name": template_name,
            "industry_code": industry_code,
            "subject": subject,
            "styles": styles,  # Store multiple styles
            "default_style": styles[0] if styles else "",  # First style is default
            "created_at": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        self.save_templates()
        return True, f"Template '{template_name}' created with ID: {template_id}"

    def delete_template(self, template_id, user):
        """Delete a template (master only)"""
        if user != self.MASTER_USERNAME or self.current_role != "master":
            return False, "Only master users can delete templates"

        if template_id not in self.templates:
            return False, "Template not found"

        # Prevent deletion if template is assigned to users
        for user_data in self.users.values():
            if user_data.get("template_id") == template_id:
                return False, "Template is assigned to users and cannot be deleted"

        del self.templates[template_id]
        self.save_templates()
        return True, f"Template {template_id} deleted successfully"

    def get_templates_by_industry(self, industry_code):
        """Get templates matching an industry code"""
        return {tid: t for tid, t in self.templates.items() if t['industry_code'] == industry_code}

    def update_user(self, username, current_password, new_industry_code=None, new_template_id=None, new_password=None):
        """Update user account information"""
        if username not in self.users:
            return False, "User not found"
        
        # Verify current password
        user = self.users[username]
        salt = bytes.fromhex(user['salt'])
        hashed_pw = hashlib.pbkdf2_hmac('sha256', current_password.encode(), salt, 100000)
        
        if hashed_pw.hex() != user['password']:
            return False, "Current password is incorrect"
        
        # Update industry code if provided
        if new_industry_code is not None:
            user['industry_code'] = new_industry_code
        
        # Update template if provided
        if new_template_id is not None:
            if new_template_id and new_template_id not in self.templates:
                return False, "Invalid template ID"
            user['template_id'] = new_template_id
        
        # Update password if provided
        if new_password:
            new_salt = os.urandom(16)
            new_hashed_pw = hashlib.pbkdf2_hmac('sha256', new_password.encode(), new_salt, 100000)
            user['password'] = new_hashed_pw.hex()
            user['salt'] = new_salt.hex()
        
        self.save_users()
        return True, "Account updated successfully"

# History Manager
class HistoryManager:
    HISTORY_FILE = "image_history.json"
    MAX_HISTORY = 3  # Keep only last 3 runs per user

    def __init__(self):
        self.history = {}
        self.load_history()

    def load_history(self):
        """Load history from file"""
        if os.path.exists(self.HISTORY_FILE):
            try:
                with open(self.HISTORY_FILE, 'r') as f:
                    self.history = json.load(f)
            except:
                self.history = {}

    def save_history(self):
        """Save history to file"""
        with open(self.HISTORY_FILE, 'w') as f:
            json.dump(self.history, f)

    def record_session(self, username, session_data):
        """Record a session to user's history"""
        if username not in self.history:
            self.history[username] = []
        
        # Convert images to base64 for storage
        session_data['images'] = [
            base64.b64encode(img).decode('utf-8') if img else None
            for img in session_data['images']
        ]
        
        # Add to history and keep only last MAX_HISTORY
        self.history[username].append(session_data)
        if len(self.history[username]) > self.MAX_HISTORY:
            self.history[username] = self.history[username][-self.MAX_HISTORY:]
        
        self.save_history()

    def get_user_history(self, username):
        """Get history for a specific user"""
        return self.history.get(username, [])

# Image generation functions
def generate_two_images(subject, style="professional photography"):
    """
    Generates two image variations based on a subject name
    """
    base_prompt = f"A photorealistic 1024x1024 image of {subject}, {style}, high quality, 8k"
    images = []
    for i in range(2):
        variation_prompt = f"{base_prompt}, variation {i+1}, unique composition"
        img_bytes, _ = get_pollinations_image(variation_prompt)
        images.append(img_bytes)
        time.sleep(1)
    return images

def get_pollinations_image(prompt, width=1024, height=1024):
    """
    Generate image using Pollinations AI API
    """
    try:
        seed = random.randint(0, 1000000)
        encoded_prompt = urllib.parse.quote(prompt)
        api_url = f"https://image.pollinations.ai/prompt/{encoded_prompt}?seed={seed}&width={width}&height={height}"
        response = requests.get(api_url, timeout=60)
        response.raise_for_status()
        return response.content, seed
    except Exception as e:
        print(f"Image generation failed: {str(e)}")
        return None, str(e)

# Authentication and Image Generation UI with feedback system
form_style = {'description_width': '150px'}
input_width = '90%'

class AuthImageSystem:
    def __init__(self):
        self.user_manager = UserManager()
        self.history_manager = HistoryManager()
        self.create_widgets()
        # State for image feedback system
        self.current_images = []
        self.current_subject = ""
        self.current_style = ""
        self.regeneration_count = 0
        self.MAX_REGENERATIONS = 20

    def create_widgets(self):
        # Sign Up Widgets
        self.signup_username = widgets.Text(
            description="Username:", style=form_style, layout=widgets.Layout(width=input_width))
        self.signup_password = widgets.Password(
            description="Password:", style=form_style, layout=widgets.Layout(width=input_width))
        self.industry_code = widgets.Text(
            description="Industry Code:", style=form_style, layout=widgets.Layout(width=input_width),
            placeholder="Enter your industry code (e.g., TECH-123)")
        self.template_dropdown = widgets.Dropdown(
            description="Template:", style=form_style, layout=widgets.Layout(width=input_width),
            options=[("None", None)], disabled=True)
        self.signup_btn = widgets.Button(
            description="Create Account", button_style='primary', layout=widgets.Layout(width='200px'))
        self.signup_status = widgets.Output()

        # Login Widgets
        self.login_username = widgets.Text(
            description="Username:", style=form_style, layout=widgets.Layout(width=input_width))
        self.login_password = widgets.Password(
            description="Password:", style=form_style, layout=widgets.Layout(width=input_width))
        self.login_btn = widgets.Button(
            description="Login", button_style='primary', layout=widgets.Layout(width='200px'))
        self.login_status = widgets.Output()

        # Template Management Widgets
        self.template_name = widgets.Text(
            description="Template Name:", style=form_style, layout=widgets.Layout(width=input_width))
        self.template_industry_code = widgets.Text(
            description="Industry Code:", style=form_style, layout=widgets.Layout(width=input_width))
        self.template_subject = widgets.Text(
            description="Default Subject:", style=form_style, layout=widgets.Layout(width=input_width),
            placeholder="e.g., Smart Watch, Spicy Tuna Roll")
        
        # NEW: Checkboxes for style selection
        self.style_checkboxes = {
            "professional photography": widgets.Checkbox(value=True, description="Professional Photography"),
            "watercolor painting": widgets.Checkbox(value=True, description="Watercolor Painting"),
            "anime": widgets.Checkbox(value=True, description="Anime Style"),
            "oil painting": widgets.Checkbox(value=True, description="Oil Painting"),
            "pencil sketch": widgets.Checkbox(value=True, description="Pencil Sketch"),
            "digital art": widgets.Checkbox(value=True, description="Digital Art"),
            "cartoon": widgets.Checkbox(value=True, description="Cartoon"),
            "3D render": widgets.Checkbox(value=True, description="3D Render"),
            "vintage": widgets.Checkbox(value=True, description="Vintage"),
            "minimalist": widgets.Checkbox(value=True, description="Minimalist")
        }
        
        # Container for style checkboxes
        self.style_checkbox_container = widgets.VBox([
            widgets.HTML("<b>Select Styles:</b>"),
            widgets.HBox(list(self.style_checkboxes.values())[:5]),
            widgets.HBox(list(self.style_checkboxes.values())[5:])
        ])
        
        self.create_template_btn = widgets.Button(
            description="Create Template", button_style='primary', layout=widgets.Layout(width='200px'))
        self.delete_template_dropdown = widgets.Dropdown(
            description="Delete Template:", style=form_style, layout=widgets.Layout(width=input_width),
            options=[("Select a template", None)])
        self.delete_template_btn = widgets.Button(
            description="Delete Template", button_style='danger', layout=widgets.Layout(width='200px'))
        self.template_status = widgets.Output()

        # Image Generation Widgets
        self.image_subject = widgets.Text(
            description="Subject:", style=form_style, layout=widgets.Layout(width=input_width),
            placeholder="e.g., Spicy Tuna Roll, Mystery Novel, Smart Watch")
        
        # NEW: Style dropdown for clients
        self.image_style_dropdown = widgets.Dropdown(
            description="Style:", style=form_style, layout=widgets.Layout(width=input_width),
            options=["professional photography"], value="professional photography"
        )
        
        # Text input for masters
        self.image_style_text = widgets.Text(
            description="Style:", style=form_style, layout=widgets.Layout(width=input_width),
            value="professional photography"
        )
        
        # Container to switch between style widgets
        self.style_widget_container = widgets.VBox([self.image_style_text])
        
        self.generate_btn = widgets.Button(
            description="Generate Images", button_style='primary', layout=widgets.Layout(width='200px'))
        self.image_output = widgets.Output()
        
        # Feedback Widgets
        self.like_this_btn = widgets.Button(
            description="I like this", 
            button_style='success',
            tooltip="Download first image",
            layout=widgets.Layout(width='120px')
        )
        self.like_that_btn = widgets.Button(
            description="I like that", 
            button_style='success',
            tooltip="Download second image",
            layout=widgets.Layout(width='120px')
        )
        self.both_bad_btn = widgets.Button(
            description="Both bad", 
            button_style='danger',
            tooltip="Regenerate new images",
            layout=widgets.Layout(width='120px')
        )
        self.feedback_status = widgets.Output()
        
        # Logout Widget
        self.logout_btn = widgets.Button(
            description="Logout", 
            button_style='warning', 
            icon='sign-out',
            layout=widgets.Layout(width='100px', margin='20px 0 0 auto')
        )
        
        # History Widgets
        self.history_output = widgets.Output()
        self.refresh_history_btn = widgets.Button(
            description="Refresh History",
            button_style='info',
            layout=widgets.Layout(width='150px')
        )
        
        # Account Management Widgets
        self.account_username = widgets.Text(
            description="Username:", style=form_style, layout=widgets.Layout(width=input_width),
            disabled=True)
        self.account_industry_code = widgets.Text(
            description="Industry Code:", style=form_style, layout=widgets.Layout(width=input_width))
        self.account_template_dropdown = widgets.Dropdown(
            description="Template:", style=form_style, layout=widgets.Layout(width=input_width),
            options=[("None", None)], disabled=False)
        self.current_password = widgets.Password(
            description="Current Password:", style=form_style, layout=widgets.Layout(width=input_width))
        self.new_password = widgets.Password(
            description="New Password:", style=form_style, layout=widgets.Layout(width=input_width),
            placeholder="Leave blank to keep current")
        self.confirm_password = widgets.Password(
            description="Confirm Password:", style=form_style, layout=widgets.Layout(width=input_width))
        self.update_account_btn = widgets.Button(
            description="Update Account", button_style='primary', layout=widgets.Layout(width='200px'))
        self.account_status = widgets.Output()

        # Attach handlers
        self.signup_btn.on_click(self.on_signup)
        self.login_btn.on_click(self.on_login)
        self.create_template_btn.on_click(self.on_create_template)
        self.delete_template_btn.on_click(self.on_delete_template)
        self.generate_btn.on_click(self.on_generate)
        self.logout_btn.on_click(self.on_logout)
        self.industry_code.observe(self.update_template_dropdown, names='value')
        self.like_this_btn.on_click(self.on_like_this)
        self.like_that_btn.on_click(self.on_like_that)
        self.both_bad_btn.on_click(self.on_both_bad)
        self.refresh_history_btn.on_click(self.display_history)
        self.account_industry_code.observe(self.update_account_template_dropdown, names='value')
        self.update_account_btn.on_click(self.on_account_update)

    def update_template_dropdown(self, change):
        """Update template dropdown based on industry code"""
        industry_code = change['new'].strip()
        templates = self.user_manager.get_templates_by_industry(industry_code)
        options = [("None", None)] + [(t['name'], tid) for tid, t in templates.items()]
        self.template_dropdown.options = options
        self.template_dropdown.disabled = not bool(templates)
        
    def update_account_template_dropdown(self, change):
        """Update account template dropdown based on industry code"""
        industry_code = change['new'].strip()
        templates = self.user_manager.get_templates_by_industry(industry_code)
        options = [("None", None)] + [(t['name'], tid) for tid, t in templates.items()]
        self.account_template_dropdown.options = options
        self.account_template_dropdown.disabled = not bool(templates)

    def on_signup(self, btn):
        username = self.signup_username.value.strip()
        password = self.signup_password.value.strip()
        industry_code = self.industry_code.value.strip()
        template_id = self.template_dropdown.value

        if not username or not password:
            with self.signup_status:
                self.signup_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Username and password are required!</div>"))
            return

        if not industry_code:
            with self.signup_status:
                self.signup_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Industry code is required!</div>"))
            return

        success, message = self.user_manager.create_user(username, password, industry_code, template_id)
        with self.signup_status:
            self.signup_status.clear_output()
            color = "green" if success else "red"
            display(HTML(f"<div style='color:{color};padding:10px'>{message}</div>"))

    def on_login(self, btn):
        username = self.login_username.value.strip()
        password = self.login_password.value.strip()

        if not username or not password:
            with self.login_status:
                self.login_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Username and password required!</div>"))
            return

        success, message = self.user_manager.authenticate(username, password)
        with self.login_status:
            self.login_status.clear_output()
            color = "green" if success else "red"
            display(HTML(f"<div style='color:{color};padding:10px'>{message}</div>"))

        if success:
            clear_output(wait=True)
            display(HTML(f"<div style='color:green;padding:10px'>{message}</div>"))
            time.sleep(3)
            clear_output(wait=True)
            display(self.show_post_login_ui())

    def on_logout(self, btn):
        """Handle logout action"""
        message = self.user_manager.logout()
        clear_output(wait=True)
        display(HTML(f"<div style='color:blue;padding:10px'>{message}</div>"))
        time.sleep(2)
        clear_output(wait=True)
        self.show_auth_ui()

    def on_create_template(self, btn):
        if self.user_manager.current_role != "master":
            with self.template_status:
                self.template_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Only master users can create templates!</div>"))
            return

        template_name = self.template_name.value.strip()
        industry_code = self.template_industry_code.value.strip()
        subject = self.template_subject.value.strip()
        
        # Get selected styles from checkboxes
        selected_styles = [style for style, cb in self.style_checkboxes.items() if cb.value]
        
        if not all([template_name, industry_code, subject]) or not selected_styles:
            with self.template_status:
                self.template_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>All template fields are required and at least one style must be selected!</div>"))
            return

        success, message = self.user_manager.create_template(
            template_name, industry_code, subject, selected_styles, self.user_manager.current_user)
        with self.template_status:
            self.template_status.clear_output()
            color = "green" if success else "red"
            display(HTML(f"<div style='color:{color};padding:10px'>{message}</div>"))
        self.update_template_delete_dropdown()
        self.update_account_template_dropdown({'new': self.account_industry_code.value})

    def on_delete_template(self, btn):
        if self.user_manager.current_role != "master":
            with self.template_status:
                self.template_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Only master users can delete templates!</div>"))
            return

        template_id = self.delete_template_dropdown.value
        if not template_id:
            with self.template_status:
                self.template_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Select a template to delete!</div>"))
            return

        success, message = self.user_manager.delete_template(template_id, self.user_manager.current_user)
        with self.template_status:
            self.template_status.clear_output()
            color = "green" if success else "red"
            display(HTML(f"<div style='color:{color};padding:10px'>{message}</div>"))
        self.update_template_delete_dropdown()
        self.update_account_template_dropdown({'new': self.account_industry_code.value})

    def on_generate(self, btn):
        subject = self.image_subject.value.strip()
        
        # Get style based on current widget
        if self.user_manager.current_role == "client":
            style = self.image_style_dropdown.value
        else:
            style = self.image_style_text.value

        if not subject:
            with self.image_output:
                self.image_output.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Subject is required!</div>"))
            return

        # Reset regeneration counter for new subject
        self.regeneration_count = 0
        self.current_subject = subject
        self.current_style = style
        
        with self.image_output:
            self.image_output.clear_output()
            display(HTML("<div style='color:blue;padding:10px'>Generating images, please wait...</div>"))
        
        self.generate_and_display_images()

    def generate_and_display_images(self):
        """Generate and display images with feedback options"""
        images = generate_two_images(self.current_subject, self.current_style)
        self.current_images = images  # Store for download
        
        # Record session in history
        if self.user_manager.current_user and any(images):
            session_data = {
                "subject": self.current_subject,
                "style": self.current_style,
                "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "images": images
            }
            self.history_manager.record_session(self.user_manager.current_user, session_data)
        
        with self.image_output:
            self.image_output.clear_output()
            
            if not any(images):
                display(HTML("<div style='color:red;padding:10px'>Failed to generate images.</div>"))
                return
                
            for i, img_bytes in enumerate(images):
                if img_bytes:
                    display(HTML(f"<h3>Image {i+1}</h3>"))
                    display(Image(img_bytes))
            
            # Display feedback buttons
            buttons_box = widgets.HBox([
                self.like_this_btn, 
                self.like_that_btn, 
                self.both_bad_btn
            ])
            display(buttons_box)
            
            # Show regeneration count if applicable
            if self.regeneration_count > 0:
                display(HTML(
                    f"<div style='color:blue;padding:10px'>"
                    f"Regeneration attempt: {self.regeneration_count}/{self.MAX_REGENERATIONS}"
                    f"</div>"
                ))

    def download_image(self, img_bytes, filename):
        """Create download link for an image"""
        b64 = base64.b64encode(img_bytes).decode()
        html = f'''
        <a download="{filename}" href="data:image/png;base64,{b64}" target="_blank">
            Click to download {filename}
        </a>
        '''
        return html

    def on_like_this(self, btn):
        """Handle 'I like this' button click - download first image"""
        if len(self.current_images) > 0 and self.current_images[0]:
            filename = f"{self.current_subject.replace(' ', '_')}_1.png"
            html = self.download_image(self.current_images[0], filename)
            with self.feedback_status:
                self.feedback_status.clear_output()
                display(HTML(f"<div style='color:green;padding:10px'>{html}</div>"))

    def on_like_that(self, btn):
        """Handle 'I like that' button click - download second image"""
        if len(self.current_images) > 1 and self.current_images[1]:
            filename = f"{self.current_subject.replace(' ', '_')}_2.png"
            html = self.download_image(self.current_images[1], filename)
            with self.feedback_status:
                self.feedback_status.clear_output()
                display(HTML(f"<div style='color:green;padding:10px'>{html}</div>"))

    def on_both_bad(self, btn):
        """Handle 'Both bad' button click - regenerate images"""
        self.regeneration_count += 1
        
        if self.regeneration_count >= self.MAX_REGENERATIONS:
            with self.image_output:
                self.image_output.clear_output()
                display(HTML(
                    "<div style='color:red;padding:10px'>"
                    "Maximum regenerations reached. Please try a different subject."
                    "</div>"
                ))
            return
            
        with self.image_output:
            self.image_output.clear_output()
            display(HTML(
                f"<div style='color:blue;padding:10px'>"
                f"Regenerating images (attempt {self.regeneration_count}/{self.MAX_REGENERATIONS})..."
                f"</div>"
            ))
        
        self.generate_and_display_images()

    def display_history(self, btn=None):
        """Display the history of generated images for current user"""
        self.history_output.clear_output()
        with self.history_output:
            if not self.user_manager.current_user:
                display(HTML("<div style='color:red;padding:10px'>Not logged in</div>"))
                return
                
            username = self.user_manager.current_user
            user_history = self.history_manager.get_user_history(username)
            
            if not user_history:
                display(HTML("<div style='padding:10px'>No history found. Generate some images first!</div>"))
                return
                
            display(HTML(f"<h3>History for {username}</h3>"))
            display(HTML(f"<p>Showing last {self.history_manager.MAX_HISTORY} sessions</p>"))
            
            # Display sessions in reverse chronological order (newest first)
            for i, session in enumerate(reversed(user_history)):
                display(HTML(f"<hr><h4>Session {i+1}: {session['timestamp']}</h4>"))
                display(HTML(f"<p><b>Subject:</b> {session['subject']}</p>"))
                display(HTML(f"<p><b>Style:</b> {session['style']}</p>"))
                
                # Display images with download buttons
                image_widgets = []
                for j, img_base64 in enumerate(session['images']):
                    if img_base64:
                        try:
                            img_bytes = base64.b64decode(img_base64)
                            img_widget = widgets.Image(value=img_bytes, format='png', width=200, height=200)
                            download_btn = widgets.Button(description=f"Download Image {j+1}")
                            download_btn.on_click(lambda b, img=img_bytes, subj=session['subject'], idx=j+1: 
                                                self.download_history_image(img, f"{subj.replace(' ', '_')}_{idx}.png"))
                            image_widgets.append(widgets.VBox([img_widget, download_btn]))
                        except:
                            continue
                if image_widgets:
                    display(widgets.HBox(image_widgets))
                else:
                    display(HTML("<div>No images available for this session</div>"))

    def download_history_image(self, img_bytes, filename):
        """Create download link for history image"""
        html = self.download_image(img_bytes, filename)
        with self.history_output:
            self.history_output.clear_output(wait=True)
            display(HTML(f"<div style='color:green;padding:10px'>{html}</div>"))
            # Refresh history view after download
            self.display_history()
            
    def on_account_update(self, btn):
        """Handle account update request"""
        if not self.user_manager.current_user:
            with self.account_status:
                self.account_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Not logged in</div>"))
            return
            
        username = self.user_manager.current_user
        current_password = self.current_password.value.strip()
        new_industry_code = self.account_industry_code.value.strip()
        new_template_id = self.account_template_dropdown.value
        new_password = self.new_password.value.strip()
        confirm_password = self.confirm_password.value.strip()
        
        # Validate inputs
        if not current_password:
            with self.account_status:
                self.account_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Current password is required</div>"))
            return
            
        if new_password and new_password != confirm_password:
            with self.account_status:
                self.account_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>New passwords do not match</div>"))
            return
            
        if not new_industry_code:
            with self.account_status:
                self.account_status.clear_output()
                display(HTML("<div style='color:red;padding:10px'>Industry code is required</div>"))
            return
            
        # Update user account
        success, message = self.user_manager.update_user(
            username,
            current_password,
            new_industry_code,
            new_template_id,
            new_password if new_password else None
        )
        
        with self.account_status:
            self.account_status.clear_output()
            color = "green" if success else "red"
            display(HTML(f"<div style='color:{color};padding:10px'>{message}</div>"))
            
        # Clear password fields
        self.current_password.value = ""
        self.new_password.value = ""
        self.confirm_password.value = ""
        
        # Update template dropdowns
        self.update_template_dropdown({'new': new_industry_code})
        self.update_account_template_dropdown({'new': new_industry_code})

    def show_signup_form(self):
        return widgets.VBox([
            widgets.HTML("<h2 style='color:#2E86e1; margin-top:0'>📝 Sign Up</h2>"),
            widgets.HTML("<p>Create a new account with your industry code</p>"),
            self.signup_username,
            self.signup_password,
            self.industry_code,
            self.template_dropdown,
            widgets.HTML("<div style='font-size:12px; color:#666; margin-top:-10px'>"
                         "Enter your industry-specific code for future features</div>"),
            self.signup_btn,
            self.signup_status
        ])

    def show_login_form(self):
        return widgets.VBox([
            widgets.HTML("<h2 style='color:#2E86e1; margin-top:0'>🔒 Login</h2>"),
            widgets.HTML("<p>Access your existing account</p>"),
            self.login_username,
            self.login_password,
            self.login_btn,
            self.login_status
        ])

    def show_template_management_form(self):
        self.update_template_delete_dropdown()
        return widgets.VBox([
            widgets.HTML("<h2 style='color:#2E86e1; margin-top:0'>🛠️ Template Management</h2>"),
            widgets.HTML("<p>Create or delete industry-specific templates (Master only)</p>"),
            self.template_name,
            self.template_industry_code,
            self.template_subject,
            self.style_checkbox_container,  # NEW: Style checkboxes
            self.create_template_btn,
            self.delete_template_dropdown,
            self.delete_template_btn,
            self.template_status
        ])

    def show_image_gen_form(self):
        # Pre-populate subject and style if user has an assigned template
        template_id = self.user_manager.users.get(self.user_manager.current_user, {}).get("template_id")
        if template_id and template_id in self.user_manager.templates:
            template = self.user_manager.templates[template_id]
            # Set subject from template
            self.image_subject.value = template["subject"]
            
            # NEW: Set up style widget based on user role
            if self.user_manager.current_role == "client":
                # Client gets dropdown with predefined styles
                self.image_style_dropdown.options = template["styles"]
                self.image_style_dropdown.value = template["default_style"]
                self.style_widget_container.children = [self.image_style_dropdown]
            else:
                # Master gets text input with default style
                self.image_style_text.value = template["default_style"]
                self.style_widget_container.children = [self.image_style_text]
            
            # Disable subject field for clients
            if self.user_manager.current_role == "client":
                self.image_subject.disabled = True
            else:
                self.image_subject.disabled = False
        else:
            # Enable subject field if no template
            self.image_subject.disabled = False
            # For users without template, use text input for style
            self.style_widget_container.children = [self.image_style_text]

        return widgets.VBox([
            widgets.HTML("<h2 style='color:#2E86e1; margin-top:0'>🖼️ Image Generator</h2>"),
            widgets.HTML("<p>Enter a subject and style to generate two images</p>"),
            self.image_subject,
            self.style_widget_container,  # Container for style widget
            self.generate_btn,
            self.image_output,
            self.feedback_status
        ])
    
    def show_history_tab(self):
        """Show history tab content"""
        return widgets.VBox([
            widgets.HTML("<h2 style='color:#2E86e1; margin-top:0'>📚 Past Records</h2>"),
            widgets.HTML("<p>Your last 3 image generation sessions</p>"),
            self.refresh_history_btn,
            self.history_output
        ])
        
    def show_account_page(self):
        """Show account management page"""
        if not self.user_manager.current_user:
            return widgets.VBox([
                widgets.HTML("<h2 style='color:#2E86e1; margin-top:0'>🔐 Account</h2>"),
                widgets.HTML("<div style='color:red;padding:10px'>Not logged in</div>")
            ])
            
        user = self.user_manager.users[self.user_manager.current_user]
        
        # Pre-populate fields
        self.account_username.value = self.user_manager.current_user
        self.account_industry_code.value = user['industry_code']
        self.account_template_dropdown.value = user.get('template_id', None)
        
        # Update template dropdown based on industry code
        self.update_account_template_dropdown({'new': user['industry_code']})
        
        return widgets.VBox([
            widgets.HTML("<h2 style='color:#2E86e1; margin-top:0'>🔐 Account Management</h2>"),
            widgets.HTML("<p>Update your account information</p>"),
            self.account_username,
            self.account_industry_code,
            self.account_template_dropdown,
            self.current_password,
            self.new_password,
            self.confirm_password,
            widgets.HTML("<div style='font-size:12px; color:#666; margin-top:-10px'>"
                         "Leave password fields unchanged to keep current password</div>"),
            self.update_account_btn,
            self.account_status
        ])

    def update_template_delete_dropdown(self):
        """Update the delete template dropdown with current templates"""
        options = [("Select a template", None)] + [
            (f"{t['name']} ({t['industry_code']})", tid) for tid, t in self.user_manager.templates.items()
        ]
        self.delete_template_dropdown.options = options

    def show_post_login_ui(self):
        """Show appropriate UI based on user role with logout button"""
        # Create header with logout button
        header = widgets.HBox([
            widgets.HTML(f"<h2 style='margin:0; flex-grow:1'>Logged in as: {self.user_manager.current_user} "
                         f"({self.user_manager.current_role})</h2>"),
            self.logout_btn
        ])
        
        if self.user_manager.current_role == "master":
            tabs = widgets.Tab()
            tabs.children = [
                self.show_image_gen_form(), 
                self.show_template_management_form(),
                self.show_history_tab(),
                self.show_account_page()
            ]
            tabs.titles = ['Image Generator', 'Template Management', 'Past Records', 'Account']
            return widgets.VBox([header, tabs])
        else:
            tabs = widgets.Tab()
            tabs.children = [
                self.show_image_gen_form(),
                self.show_history_tab(),
                self.show_account_page()
            ]
            tabs.titles = ['Image Generator', 'Past Records', 'Account']
            return widgets.VBox([header, tabs])

    def show_auth_ui(self):
        """Display authentication UI with signup and login tabs"""
        auth_tabs = widgets.Tab()
        auth_tabs.children = [self.show_signup_form(), self.show_login_form()]
        auth_tabs.titles = ['Sign Up', 'Login']
        display(auth_tabs)

# Create instance and display UI
auth_image_system = AuthImageSystem()
auth_image_system.show_auth_ui()
